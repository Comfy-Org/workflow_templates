name: E2E Tests (Site)

on:
  push:
    branches: [main]
    paths:
      - 'site/**'
      - '.github/workflows/e2e-tests-site.yml'
  pull_request:
    branches: [main]
    paths:
      - 'site/**'
      - '.github/workflows/e2e-tests-site.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: site
    steps:
      - name: Setup
        uses: ./.github/actions/site-setup

      - name: Setup Playwright
        uses: ./.github/actions/setup-playwright

      - name: Build site
        run: pnpm run build
        env:
          SKIP_AI_GENERATION: 'true'

      - name: Run E2E tests
        id: e2e
        continue-on-error: true
        run: pnpm run test:e2e

      - name: Upload test artifacts
        if: steps.e2e.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            site/test-results/
            site/playwright-report/
          retention-days: 14

      - name: Build comment body
        if: always() && github.event_name == 'pull_request'
        id: comment
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const outcome = '${{ steps.e2e.outcome }}';
            const passed = outcome === 'success';

            const lines = ['<!-- site-e2e-results -->', '## ğŸ§ª E2E Test Results', ''];

            if (passed) {
              lines.push('âœ… All end-to-end tests passed.');
            } else {
              lines.push(
                'âŒ End-to-end tests detected failures in this PR.',
                '',
                'ğŸ“¦ Download the **e2e-test-results** artifact for the full Playwright report.',
                '',
                'To reproduce locally:',
                '```bash',
                'cd site',
                'pnpm run build',
                'pnpm run test:e2e',
                '```',
              );
            }

            lines.push('', '---', '*Generated by E2E Tests workflow*');
            return lines.join('\n');

      - name: Comment on PR
        if: always() && github.event_name == 'pull_request' && steps.comment.outputs.result
        uses: ./.github/actions/upsert-pr-comment
        with:
          marker: '<!-- site-e2e-results -->'
          body: ${{ steps.comment.outputs.result }}

      - name: Fail if tests failed
        if: steps.e2e.outcome == 'failure'
        run: exit 1
