---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ThumbnailDisplay from '../../components/ThumbnailDisplay.astro';
import { DEFAULT_LOCALE } from '../../i18n/config';
import { getTemplatesForLocale } from '../../lib/templates';
import { t, localizeUrl } from '../../i18n';
import { getCloudCtaUrl } from '../../lib/urls';

export async function getStaticPaths() {
  // Only generate English (default locale) pages here
  // Localized pages are generated by [locale]/templates/[slug].astro
  const templates = await getTemplatesForLocale(DEFAULT_LOCALE);
  return templates.map((template) => ({
    params: { slug: template.data.name },
    props: { template },
  }));
}

const { template } = Astro.props;
const locale = DEFAULT_LOCALE;
const { data } = template;

const siteUrl = Astro.site?.origin || 'https://templates.comfy.org';
const title = `${data.title || data.name} - ComfyUI Workflow`;
const hreflangBasePath = `/templates/${data.name}/`;
const canonicalUrl = `${siteUrl}${hreflangBasePath}`;

const thumbnails = data.thumbnails || [];
const primaryThumbnail = thumbnails[0] || null;
const ogImage = `/og/${data.name}.png`;
const workflowPreviewPath = `/previews/${data.name}.png`;

const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'TechArticle',
  headline: data.title || data.name,
  description: data.description,
  image: primaryThumbnail
    ? `https://templates.comfy.org/thumbnails/${primaryThumbnail}`
    : undefined,
  datePublished: data.date,
  inLanguage: 'en',
};

const faqStructuredData = data.faqItems?.length
  ? {
      '@context': 'https://schema.org',
      '@type': 'FAQPage',
      mainEntity: data.faqItems.map((item: { question: string; answer: string }) => ({
        '@type': 'Question',
        name: item.question,
        acceptedAnswer: { '@type': 'Answer', text: item.answer },
      })),
    }
  : null;

const breadcrumbStructuredData = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Home', item: siteUrl },
    { '@type': 'ListItem', position: 2, name: 'Templates', item: `${siteUrl}/templates/` },
    { '@type': 'ListItem', position: 3, name: data.title || data.name, item: canonicalUrl },
  ],
};

const softwareAppStructuredData = {
  '@context': 'https://schema.org',
  '@type': 'SoftwareApplication',
  name: data.title || data.name,
  applicationCategory: 'MultimediaApplication',
  operatingSystem: 'Windows, macOS, Linux',
  description: data.metaDescription || data.description,
  offers: {
    '@type': 'Offer',
    price: '0',
    priceCurrency: 'USD',
  },
};

const mediaTypeLabels: Record<string, string> = {
  image: 'Image Generation',
  video: 'Video Generation',
  audio: 'Audio Generation',
  '3d': '3D Generation',
};

function formatDate(dateStr: string): string {
  const localeMap: Record<string, string> = {
    en: 'en-US',
    zh: 'zh-CN',
    'zh-TW': 'zh-TW',
    ja: 'ja-JP',
    ko: 'ko-KR',
    es: 'es-ES',
    fr: 'fr-FR',
    ru: 'ru-RU',
    tr: 'tr-TR',
    ar: 'ar-SA',
    'pt-BR': 'pt-BR',
  };
  return new Date(dateStr).toLocaleDateString(localeMap[locale] || 'en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

function formatBytes(bytes: number): string {
  const gb = bytes / (1024 * 1024 * 1024);
  return gb >= 1 ? `${gb.toFixed(1)} GB` : `${(bytes / (1024 * 1024)).toFixed(0)} MB`;
}

function slugifyTag(tag: string): string {
  return tag
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-|-$/g, '');
}
---

<BaseLayout
  title={title}
  description={data.metaDescription || data.description}
  canonicalUrl={canonicalUrl}
  ogImage={ogImage}
  ogType="article"
  structuredData={structuredData}
  hreflangBasePath={hreflangBasePath}
>
  <article class="max-w-4xl mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-8">
      <a
        href={localizeUrl('/templates/', locale)}
        class="inline-flex items-center gap-2 text-indigo-600 hover:text-indigo-800 font-medium transition-colors"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"
          ></path>
        </svg>
        {t('nav.back', locale)}
      </a>
    </nav>

    <!-- Header -->
    <header class="mb-8">
      <div class="flex flex-wrap items-center gap-3 text-sm text-gray-500 mb-3">
        <a
          href={localizeUrl(`/category/${data.mediaType}/`, locale)}
          class="px-2.5 py-1 bg-indigo-100 text-indigo-700 font-medium rounded-full hover:bg-indigo-200 transition-colors"
          data-astro-prefetch
        >
          {mediaTypeLabels[data.mediaType]}
        </a>
        {data.date && <span>{formatDate(data.date)}</span>}
        {
          data.usage !== undefined && (
            <span class="flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 10V3L4 14h7v7l9-11h-7z"
                />
              </svg>
              {data.usage.toLocaleString()} runs
            </span>
          )
        }
        {
          data.openSource === false && (
            <span class="px-2.5 py-1 bg-amber-100 text-amber-700 font-medium rounded-full">
              Cloud API
            </span>
          )
        }
      </div>

      <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-4">
        {data.title || data.name}
      </h1>

      <p class="text-xl text-gray-600 leading-relaxed">
        {data.description}
      </p>
    </header>

    <!-- Hero Image -->
    {
      thumbnails.length > 0 && (
        <figure class="mb-8 rounded-xl overflow-hidden bg-gray-100 shadow-lg">
          <ThumbnailDisplay
            thumbnails={thumbnails}
            title={data.title || data.name}
            variant={data.thumbnailVariant}
            mediaSubtype={data.mediaSubtype}
            class="w-full aspect-video"
            loading="eager"
            fetchpriority="high"
            sizes="(max-width: 896px) 100vw, 896px"
          />
          <figcaption class="px-4 py-3 bg-gray-50 text-sm text-gray-600 text-center">
            {data.thumbnailVariant === 'compareSlider'
              ? 'Drag the slider to compare input and output'
              : data.thumbnailVariant === 'hoverDissolve'
                ? 'Hover to see the transformation'
                : 'Example output generated by this workflow'}
          </figcaption>
        </figure>
      )
    }

    <!-- CTA Button -->
    <div
      class="mb-12 p-6 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border border-indigo-100"
    >
      <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
        <div>
          <h2 class="text-lg font-semibold text-gray-900 mb-1">Try this workflow</h2>
          <p class="text-gray-600">Run instantly on Comfy Cloud â€” no setup required</p>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <a
            href={getCloudCtaUrl(data.name, 'hero')}
            class="inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors shadow-md hover:shadow-lg"
          >
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
            Run on Comfy Cloud
          </a>
          <a
            href={`/workflows/${data.name}.json`}
            download
            class="download-json-btn inline-flex items-center gap-2 px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100 hover:border-gray-400 transition-colors"
            data-template={data.name}
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            {t('cta.downloadJson', locale)}
          </a>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="prose prose-lg prose-gray max-w-none">
      <!-- About -->
      <section class="mb-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">About This Workflow</h2>
        <p class="text-gray-700 leading-relaxed">
          {data.extendedDescription || data.description}
        </p>
      </section>

      <!-- More Examples -->
      {
        thumbnails.length > 1 && (
          <section class="mb-12">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">More Examples</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
              {thumbnails.slice(1).map((thumb: string, index: number) => (
                <img
                  src={`/thumbnails/${thumb}`}
                  alt={`${data.title || data.name} example ${index + 2}`}
                  class="rounded-lg shadow-md"
                  loading="lazy"
                  width="320"
                  height="180"
                  decoding="async"
                  sizes="(max-width: 640px) 50vw, (max-width: 896px) 33vw, 280px"
                />
              ))}
            </div>
          </section>
        )
      }

      <!-- How to Use -->
      {
        data.howToUse && data.howToUse.length > 0 && (
          <section class="mb-12">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">How to Use</h2>
            <div class="space-y-4">
              {data.howToUse.map((step: string, i: number) => (
                <div class="flex gap-4 items-start p-4 bg-gray-50 rounded-lg">
                  <span class="flex-shrink-0 w-8 h-8 bg-indigo-600 text-white font-bold rounded-full flex items-center justify-center text-sm">
                    {i + 1}
                  </span>
                  <p class="text-gray-700 pt-1">{step}</p>
                </div>
              ))}
            </div>
          </section>
        )
      }

      <!-- Workflow Preview -->
      <section class="mb-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Workflow Structure</h2>
        <figure class="rounded-xl overflow-hidden border border-gray-200 bg-gray-900">
          <img
            src={workflowPreviewPath}
            alt={`Workflow graph for ${data.title || data.name}`}
            class="w-full"
            loading="lazy"
            width="1200"
            height="600"
            decoding="async"
            sizes="(max-width: 896px) 100vw, 896px"
          />
          <figcaption class="px-4 py-3 bg-gray-800 text-sm text-gray-400 text-center">
            ComfyUI node graph visualization
          </figcaption>
        </figure>
        <p class="mt-3 text-sm text-gray-500 italic">
          Note: This is a simplified visualization. The actual workflow may contain additional nodes
          and connections.
        </p>
      </section>

      <!-- Use Cases -->
      {
        data.suggestedUseCases && data.suggestedUseCases.length > 0 && (
          <section class="mb-12">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Use Cases</h2>
            <ul class="space-y-2">
              {data.suggestedUseCases.map((useCase: string) => (
                <li class="flex items-start gap-3 text-gray-700">
                  <svg
                    class="w-5 h-5 text-green-500 mt-0.5 flex-shrink-0"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 13l4 4L19 7"
                    />
                  </svg>
                  {useCase}
                </li>
              ))}
            </ul>
          </section>
        )
      }

      <!-- Technical Details -->
      <section class="mb-12 p-6 bg-gray-50 rounded-xl">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Technical Details</h2>
        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          {
            data.models && data.models.length > 0 && (
              <div>
                <dt class="text-sm font-medium text-gray-500 mb-1">Models</dt>
                <dd class="flex flex-wrap gap-2">
                  {data.models.map((model: string) => (
                    <a
                      href={localizeUrl(`/model/${model}/`, locale)}
                      class="px-2 py-1 bg-white border border-gray-200 text-gray-700 text-sm rounded hover:bg-gray-100 hover:border-gray-300 transition-colors"
                      data-astro-prefetch
                    >
                      {model}
                    </a>
                  ))}
                </dd>
              </div>
            )
          }
          {
            data.tags && data.tags.length > 0 && (
              <div>
                <dt class="text-sm font-medium text-gray-500 mb-1">Tags</dt>
                <dd class="flex flex-wrap gap-2">
                  {data.tags.map((tag: string) => (
                    <a
                      href={localizeUrl(`/tag/${slugifyTag(tag)}/`, locale)}
                      class="px-2 py-1 bg-white border border-gray-200 text-gray-700 text-sm rounded hover:bg-gray-100 hover:border-gray-300 transition-colors"
                      data-astro-prefetch
                    >
                      {tag}
                    </a>
                  ))}
                </dd>
              </div>
            )
          }
          {
            data.size && (
              <div>
                <dt class="text-sm font-medium text-gray-500 mb-1 flex items-center gap-1.5">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                    />
                  </svg>
                  {t('labels.size', locale)}
                </dt>
                <dd class="text-gray-700 font-medium">{formatBytes(data.size)}</dd>
              </div>
            )
          }
          {
            data.vram && (
              <div>
                <dt class="text-sm font-medium text-gray-500 mb-1 flex items-center gap-1.5">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"
                    />
                  </svg>
                  {t('labels.vram', locale)}
                </dt>
                <dd class="text-gray-700 font-medium">{formatBytes(data.vram)}</dd>
              </div>
            )
          }
          {
            data.estimatedTime && (
              <div>
                <dt class="text-sm font-medium text-gray-500 mb-1 flex items-center gap-1.5">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  {t('labels.estimatedTime', locale)}
                </dt>
                <dd class="text-gray-700 font-medium">{data.estimatedTime}</dd>
              </div>
            )
          }
        </dl>
      </section>

      <!-- Required Custom Nodes -->
      {
        data.requiredNodes && data.requiredNodes.length > 0 && (
          <section class="mb-12 p-6 bg-amber-50 rounded-xl border border-amber-100">
            <h2 class="text-xl font-bold text-gray-900 mb-3 flex items-center gap-2">
              <svg
                class="w-5 h-5 text-amber-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
                />
              </svg>
              {t('labels.requiredNodes', locale)}
            </h2>
            <p class="text-sm text-amber-700 mb-4">{t('labels.managerTip', locale)}</p>
            <ul class="space-y-2">
              {data.requiredNodes.map(
                (node: {
                  nodeType: string;
                  package: string;
                  url: string;
                  description?: string;
                }) => (
                  <li class="flex items-start gap-3 p-3 bg-white rounded-lg border border-amber-100">
                    <svg
                      class="w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
                      />
                    </svg>
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-2 flex-wrap">
                        <span class="font-medium text-gray-900">{node.package}</span>
                        <a
                          href={node.url}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="inline-flex items-center gap-1 text-xs px-2 py-1 bg-amber-100 text-amber-800 rounded hover:bg-amber-200 transition-colors"
                        >
                          <svg
                            class="w-3 h-3"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                            />
                          </svg>
                          GitHub
                        </a>
                      </div>
                      {node.description && (
                        <p class="text-sm text-gray-600 mt-1">{node.description}</p>
                      )}
                      <p class="text-xs text-gray-500 mt-1">
                        Uses: <code class="px-1 py-0.5 bg-gray-100 rounded">{node.nodeType}</code>
                      </p>
                    </div>
                  </li>
                )
              )}
            </ul>
            <div class="mt-4 pt-4 border-t border-amber-200">
              <a
                href="https://github.com/ltdrdata/ComfyUI-Manager"
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-2 text-sm text-amber-800 hover:text-amber-900 font-medium"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
                {t('labels.installWithManager', locale)}
              </a>
            </div>
          </section>
        )
      }

      <!-- FAQ -->
      {
        data.faqItems && data.faqItems.length > 0 && (
          <section class="mb-12">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Frequently Asked Questions</h2>
            <div class="space-y-3">
              {data.faqItems.map((item: { question: string; answer: string }) => (
                <details class="group border border-gray-200 rounded-lg overflow-hidden">
                  <summary class="flex items-center justify-between p-4 cursor-pointer bg-white hover:bg-gray-50 transition-colors">
                    <span class="font-medium text-gray-900">{item.question}</span>
                    <svg
                      class="w-5 h-5 text-gray-500 group-open:rotate-180 transition-transform"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M19 9l-7 7-7-7"
                      />
                    </svg>
                  </summary>
                  <div class="px-4 pb-4 text-gray-700">{item.answer}</div>
                </details>
              ))}
            </div>
          </section>
        )
      }
    </div>

    <!-- Footer CTA -->
    <footer class="mt-12 p-8 bg-gradient-to-r from-gray-900 to-indigo-900 rounded-2xl text-center">
      <h2 class="text-2xl font-bold text-white mb-2">Ready to create?</h2>
      <p class="text-gray-300 mb-6">Start generating with this workflow in seconds</p>
      <a
        href={getCloudCtaUrl(data.name, 'footer')}
        class="inline-flex items-center gap-2 px-8 py-4 bg-white text-gray-900 font-bold rounded-lg hover:bg-gray-100 transition-colors shadow-lg"
      >
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
          <polygon points="5 3 19 12 5 21 5 3"></polygon>
        </svg>
        Run on Comfy Cloud
      </a>
    </footer>
  </article>

  {
    faqStructuredData && (
      <script is:inline type="application/ld+json" set:html={JSON.stringify(faqStructuredData)} />
    )
  }
  <script
    is:inline
    type="application/ld+json"
    set:html={JSON.stringify(softwareAppStructuredData)}
  />
  <script
    is:inline
    type="application/ld+json"
    set:html={JSON.stringify(breadcrumbStructuredData)}
  />
  <script is:inline define:vars={{ templateName: data.name }}>
    document.querySelectorAll('a[href*="comfycloud.app"]').forEach((link) => {
      link.addEventListener('click', () => {
        const location = link.closest('footer') ? 'footer' : 'hero';
        if (window.va) {
          window.va('event', { name: 'cta_click', template: templateName, location });
        }
      });
    });
    document.querySelectorAll('.download-json-btn').forEach((link) => {
      link.addEventListener('click', () => {
        if (window.va) {
          window.va('event', { name: 'download_json', template: templateName });
        }
      });
    });
  </script>
</BaseLayout>
