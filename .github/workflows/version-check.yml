name: Version Check and Auto-bump

# This workflow automatically bumps package versions when templates change.
# 
# Process:
#   1. Syncs manifests with SHA256 hashes (updates core package manifest.json)
#   2. Validates bundles.json completeness
#   3. Detects which packages have template changes (via git history)
#   4. Bumps version numbers for affected packages (including core if manifest changed)
#   5. Updates meta package dependencies (exact pinning)
#   6. Commits changes back to PR branch
#
# Critical: sync_bundles.py validates that ALL templates are assigned to bundles
# Note: Manifest sync must run BEFORE version detection so core package changes are detected

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'templates/**'
      - 'bundles.json'
      - 'pyproject.toml'

permissions:
  contents: write
  pull-requests: write

jobs:
  version-check:
    runs-on: ubuntu-latest
    # Only run on same-repo PRs (skip fork PRs as they can't auto-commit)
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    # Prevent concurrent version-check runs on same PR (unique per fork+branch)
    concurrency:
      group: version-check-${{ github.event.pull_request.number }}-${{ github.event.pull_request.head.repo.full_name }}
      cancel-in-progress: true
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Sync manifests and bundles (first)
        run: |
          echo "=== Validating bundles.json and syncing manifests ==="
          # This step validates that all templates are assigned to bundles
          # and generates updated manifest files with SHA256 hashes
          # Must run BEFORE version detection so core package manifest.json changes are detected
          python scripts/sync_bundles.py
          echo "‚úÖ Manifest sync complete"

      - name: Auto-bump package versions if needed
        run: |
          echo "=== Analyzing template changes and bumping versions ==="
          # This runs AFTER manifest sync so it can detect core package changes
          python scripts/ci_version_manager.py
          echo "‚úÖ Version analysis complete"

      - name: Commit version bumps and manifest updates to PR
        run: |
          echo "=== Committing automated changes to PR ==="
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Stage all potential changes from version bumps and manifest sync
          git add pyproject.toml packages/*/pyproject.toml packages/*/src/*/manifest.json

          # Only commit when root pyproject.toml version was changed (i.e. auto-bump ran).
          # When version unchanged, ci_version_manager.py skips bump and we skip committing
          # (including manifest.json) to avoid churn on every template-only PR.
          if git diff --cached --quiet; then
            echo "‚úÖ No package version or manifest changes needed"
            exit 0
          fi
          if ! git diff --cached --name-only | grep -q 'pyproject\.toml'; then
            echo "‚úÖ Root version unchanged; skipping commit (no version bump performed)"
            git reset HEAD
            exit 0
          fi
          echo "üìù Version bump and/or manifest changes - committing to PR branch"

          # Commit with retry logic in case of conflicts
          if ! git commit -m "Auto-bump package versions and sync manifests for template changes"; then
            echo "‚ö†Ô∏è Commit failed, possibly due to conflicts. Retrying..."
            if ! git pull origin "${{ github.head_ref }}" --rebase; then
              echo "‚ùå Rebase failed due to conflicts. Manual intervention required."
              git status
              exit 1
            fi
            git commit -m "Auto-bump package versions and sync manifests for template changes"
          fi

          # Push with retry logic
          if ! git push origin HEAD; then
            echo "‚ö†Ô∏è Push failed, retrying after pull..."
            if ! git pull origin "${{ github.head_ref }}" --rebase; then
              echo "‚ùå Rebase failed due to conflicts. Manual intervention required."
              git status
              exit 1
            fi
            git push origin HEAD
          fi

          echo "‚úÖ Package version bumps and manifest updates committed to PR"