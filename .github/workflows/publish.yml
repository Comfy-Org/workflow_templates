name: Publish to PyPI

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "pyproject.toml"

jobs:
  check-version-change:
    runs-on: ubuntu-latest
    outputs:
      version-changed: ${{ steps.check.outputs.changed }}
      new-version: ${{ steps.check.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for tags and version comparison

      - name: Check if version actually changed
        id: check
        run: |
          CURRENT_VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          PREVIOUS_VERSION=$(git show HEAD~1:pyproject.toml | python -c "import tomllib, sys; print(tomllib.load(sys.stdin.buffer)['project']['version'])")

          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "Version changed from $PREVIOUS_VERSION to $CURRENT_VERSION"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Version unchanged: $CURRENT_VERSION"
          fi

  publish:
    needs: check-version-change
    if: needs.check-version-change.outputs.version-changed == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for tags and bump_versions.py

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Node dependencies
        run: npm ci

      - name: Lint YAML files
        run: |
          npm install -g yaml-lint
          yamllint .github/workflows/publish.yml

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install build tooling
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip build

      - name: Sync manifest and bundle assets
        run: |
          source .venv/bin/activate
          python scripts/sync_bundles.py

      - name: Auto-bump package versions based on changes
        run: |
          source .venv/bin/activate
          # Find the previous release tag (excluding the current version)
          CURRENT_VERSION="${{ needs.check-version-change.outputs.new-version }}"
          PREV_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | grep -v "v${CURRENT_VERSION}" | head -1)
          
          if [ -z "$PREV_TAG" ]; then
            echo "No previous release tag found, using HEAD~1 as fallback"
            python scripts/bump_versions.py --base-ref HEAD~1
          else
            echo "Comparing against previous release tag: $PREV_TAG"
            python scripts/bump_versions.py --base-ref "$PREV_TAG"
          fi

      - name: Determine changed packages
        id: changed-packages
        run: |
          source .venv/bin/activate
          # Get packages that were just bumped by bump_versions.py
          CHANGED_OUTPUT=$(python scripts/bump_versions.py --dry-run 2>/dev/null || echo "")
          
          # Extract package names from bump_versions.py output
          PACKAGES=$(echo "$CHANGED_OUTPUT" | grep -E '^\s*-\s+\w+:' | sed 's/.*- \([^:]*\):.*/\1/' | tr '\n' ' ' | sed 's/[[:space:]]*$//')
          
          # If no packages detected or on manual trigger, build all packages
          if [ -z "$PACKAGES" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PACKAGES="core media_api media_video media_image media_other meta"
          fi
          
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "Building packages: $PACKAGES"

      - name: Build packages
        run: |
          source .venv/bin/activate
          rm -rf dist
          mkdir dist
          for pkg in ${{ steps.changed-packages.outputs.packages }}; do
            echo "Building package: $pkg"
            python -m build --outdir dist packages/$pkg
          done

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
          password: ${{ secrets.PYPI_TOKEN }}
          attestations: false

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "v${{ needs.check-version-change.outputs.new-version }}" \
          --title "v${{ needs.check-version-change.outputs.new-version }}" \
          --generate-notes
