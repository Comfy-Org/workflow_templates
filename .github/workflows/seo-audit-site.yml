name: SEO Audit (Site)

on:
  push:
    branches: [main]
    paths:
      - 'site/**'
      - '.github/workflows/seo-audit-site.yml'
  pull_request:
    branches: [main]
    paths:
      - 'site/**'
      - '.github/workflows/seo-audit-site.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  seo-audit:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: site
    steps:
      - name: Setup
        uses: ./.github/actions/site-setup

      - name: Build site
        run: pnpm build
        env:
          SKIP_AI_GENERATION: 'true'

      - name: Validate sitemap
        id: sitemap
        continue-on-error: true
        run: |
          echo "## Sitemap Validation" >> $GITHUB_STEP_SUMMARY
          if pnpm validate:sitemap 2>&1 | tee sitemap-output.txt; then
            echo "‚úÖ Sitemap validation passed" >> $GITHUB_STEP_SUMMARY
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Sitemap validation failed" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat sitemap-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Run SEO audit
        id: seo
        continue-on-error: true
        run: |
          echo "## SEO Audit" >> $GITHUB_STEP_SUMMARY
          if pnpm audit:seo 2>&1 | tee seo-output.txt; then
            echo "‚úÖ SEO audit passed" >> $GITHUB_STEP_SUMMARY
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è SEO audit found issues" >> $GITHUB_STEP_SUMMARY
            echo "status=issues" >> $GITHUB_OUTPUT
          fi
          echo '<details><summary>Full SEO Report</summary>' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          sed 's/\x1b\[[0-9;]*m//g' seo-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo '</details>' >> $GITHUB_STEP_SUMMARY

      - name: Check internal links
        id: links
        continue-on-error: true
        run: |
          echo "## Link Check" >> $GITHUB_STEP_SUMMARY
          BROKEN_LINKS=""
          BROKEN_COUNT=0
          TOTAL_COUNT=0

          for htmlfile in $(find dist -name '*.html' | head -500); do
            hrefs=$(grep -oP 'href="(/[^"]*)"' "$htmlfile" | sed 's/href="//;s/"$//' || true)
            for href in $hrefs; do
              TOTAL_COUNT=$((TOTAL_COUNT + 1))
              clean="${href%%#*}"
              clean="${clean%%\?*}"
              if [ -z "$clean" ] || [ "$clean" = "/" ]; then
                continue
              fi
              target="dist${clean}"
              if [ "${target: -1}" = "/" ]; then
                target="${target}index.html"
              fi
              if [ ! -f "$target" ] && [ ! -f "${target}.html" ] && [ ! -d "dist${clean}" ]; then
                BROKEN_LINKS="${BROKEN_LINKS}\n- \`${href}\` (in ${htmlfile#dist/})"
                BROKEN_COUNT=$((BROKEN_COUNT + 1))
              fi
            done
          done

          if [ "$BROKEN_COUNT" -eq 0 ]; then
            echo "‚úÖ All internal links valid ($TOTAL_COUNT checked)" >> $GITHUB_STEP_SUMMARY
            echo "status=passed" >> $GITHUB_OUTPUT
            echo "broken_count=0" >> $GITHUB_OUTPUT
            echo "total_count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Found $BROKEN_COUNT broken internal links out of $TOTAL_COUNT" >> $GITHUB_STEP_SUMMARY
            echo -e "$BROKEN_LINKS" >> $GITHUB_STEP_SUMMARY
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "broken_count=$BROKEN_COUNT" >> $GITHUB_OUTPUT
            echo "total_count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
          fi

      - name: Build comment body
        if: always() && github.event_name == 'pull_request'
        id: comment
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const fs = require('fs');

            const sitemapStatus = '${{ steps.sitemap.outputs.status }}';
            const seoStatus = '${{ steps.seo.outputs.status }}';
            const linksStatus = '${{ steps.links.outputs.status }}';
            const brokenCount = '${{ steps.links.outputs.broken_count }}';
            const totalCount = '${{ steps.links.outputs.total_count }}';

            const icon = (status) => {
              if (status === 'passed') return '‚úÖ';
              if (status === 'failed') return '‚ùå';
              if (status === 'issues') return '‚ö†Ô∏è';
              return '‚ùì';
            };

            let seoSummary = '';
            try {
              const raw = fs.readFileSync('site/seo-summary.json', 'utf8');
              const data = JSON.parse(raw);
              const lines = [
                `**${data.pagesScanned}** pages scanned, **${data.pagesClean}** clean, **${data.pagesWithIssues}** with issues`,
                '',
                `| Severity | Count |`,
                `|----------|-------|`,
                `| ‚úñ Critical | ${data.critical} |`,
                `| ‚ö† Warning | ${data.warnings} |`,
                `| ‚Ñπ Info | ${data.info} |`,
              ];
              if (data.topIssues && data.topIssues.length > 0) {
                lines.push('', '**Most common issues:**');
                for (const issue of data.topIssues.slice(0, 5)) {
                  lines.push(`- ${issue.message} (√ó${issue.count})`);
                }
              }
              seoSummary = lines.join('\n');
            } catch (e) {
              try {
                const raw = fs.readFileSync('site/seo-output.txt', 'utf8');
                const clean = raw.replace(/\x1b\[[0-9;]*m/g, '');
                const summaryMatch = clean.match(/SUMMARY[\s\S]*$/);
                seoSummary = summaryMatch ? '```\n' + summaryMatch[0].slice(0, 1500) + '\n```' : 'Could not parse SEO output';
              } catch (e2) {
                seoSummary = 'Could not read SEO output';
              }
            }

            const linksDetail = linksStatus === 'passed'
              ? `All internal links valid (${totalCount} checked)`
              : `${brokenCount} broken internal links out of ${totalCount} checked`;

            const lines = [
              '<!-- site-seo-audit-results -->',
              '## üîç SEO Audit Results',
              '',
              '| Check | Status |',
              '|-------|--------|',
              `| Sitemap Validation | ${icon(sitemapStatus)} ${sitemapStatus} |`,
              `| SEO Audit | ${icon(seoStatus)} ${seoStatus} |`,
              `| Internal Links | ${icon(linksStatus)} ${linksStatus} |`,
              '',
              '<details>',
              '<summary>üìä SEO Audit Details</summary>',
              '',
              seoSummary,
              '',
              '</details>',
              '',
              '<details>',
              '<summary>üîó Link Check Details</summary>',
              '',
              linksDetail,
              '',
              '</details>',
              '',
              '---',
              '*Generated by SEO Audit workflow*',
            ];

            return lines.join('\n');

      - name: Comment on PR
        if: always() && github.event_name == 'pull_request' && steps.comment.outputs.result
        uses: ./.github/actions/upsert-pr-comment
        with:
          marker: '<!-- site-seo-audit-results -->'
          body: ${{ steps.comment.outputs.result }}

      - name: Fail if critical issues
        run: |
          if [ "${{ steps.sitemap.outputs.status }}" = "failed" ]; then
            echo "Sitemap validation failed"
            exit 1
          fi
          if [ "${{ steps.links.outputs.status }}" = "failed" ]; then
            echo "Broken internal links found"
            exit 1
          fi
