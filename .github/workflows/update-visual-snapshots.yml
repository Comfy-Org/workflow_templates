name: Update Visual Snapshots

on:
  pull_request:
    types: [labeled]
  issue_comment:
    types: [created]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  update-snapshots:
    name: Update Visual Snapshots
    runs-on: ubuntu-latest
    if: >
      ( github.event_name == 'pull_request' && github.event.label.name == 'New Browser Test Expectations' ) ||
      ( github.event.issue.pull_request &&
        github.event_name == 'issue_comment' &&
        (
          github.event.comment.author_association == 'OWNER' ||
          github.event.comment.author_association == 'MEMBER' ||
          github.event.comment.author_association == 'COLLABORATOR'
        ) &&
        startsWith(github.event.comment.body, '/update-playwright') )
    defaults:
      run:
        working-directory: site
    steps:
      - name: Resolve PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber, headRef;
            if (context.eventName === 'pull_request') {
              prNumber = context.payload.pull_request.number;
              headRef = context.payload.pull_request.head.ref;
            } else {
              prNumber = context.payload.issue.number;
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              });
              headRef = pr.head.ref;
            }
            core.setOutput('number', prNumber);
            core.setOutput('branch', headRef);

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.branch }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Post status comment
        uses: ./.github/actions/upsert-pr-comment
        with:
          marker: '<!-- update-visual-snapshots -->'
          body: |
            <!-- update-visual-snapshots -->
            ## ðŸ“¸ Updating Visual Snapshots

            â³ Running Playwright with `--update-snapshots`...

            _Triggered by ${{ github.event_name == 'pull_request' && 'label' || 'slash command' }}_

      - name: Setup
        uses: ./.github/actions/site-setup

      - name: Setup Playwright
        uses: ./.github/actions/setup-playwright

      - name: Build site
        run: pnpm run build
        env:
          SKIP_AI_GENERATION: 'true'

      - name: Update snapshots
        run: pnpm run test:visual:update
        continue-on-error: true

      - name: Check for changes
        id: changes
        run: |
          changed=$(git diff --name-only tests/ 2>/dev/null || true)
          new=$(git ls-files --others --exclude-standard tests/ 2>/dev/null || true)
          all_changes=$(echo -e "${changed}\n${new}" | sort -u | grep -E 'snapshots/' || true)
          if [ -n "$all_changes" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$all_changes" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add tests/visual.spec.ts-snapshots/
          git commit -m "[automated] Update visual regression snapshots"
          git push origin ${{ steps.pr.outputs.branch }}

      - name: Comment â€” success
        if: always()
        uses: ./.github/actions/upsert-pr-comment
        with:
          marker: '<!-- update-visual-snapshots -->'
          body: |
            <!-- update-visual-snapshots -->
            ## ðŸ“¸ Visual Snapshots Updated

            ${{ steps.changes.outputs.has_changes == 'true' && 'âœ… Snapshots updated and committed.' || 'âœ… No snapshot changes needed.' }}

            ---
            *Generated by Update Visual Snapshots workflow*

      - name: Remove label
        if: always()
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ steps.pr.outputs.number }} --remove-label "New Browser Test Expectations" 2>/dev/null || true
