name: Visual Regression (Site)

on:
  pull_request:
    paths:
      - 'site/**'
      - '.github/workflows/visual-regression-site.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  visual-regression:
    name: Visual Regression
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: site
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/site-setup

      - name: Setup Playwright
        uses: ./.github/actions/setup-playwright

      - name: Build site
        run: pnpm run build
        env:
          SKIP_AI_GENERATION: 'true'

      - name: Check if snapshots exist
        id: snapshots
        run: |
          if [ -d "tests/visual.spec.ts-snapshots" ] && [ "$(ls tests/visual.spec.ts-snapshots/*.png 2>/dev/null | wc -l)" -gt 0 ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No baseline snapshots found. Run 'pnpm run test:visual:update' locally and commit the snapshots." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run visual regression tests
        id: visual-tests
        if: steps.snapshots.outputs.exists == 'true'
        continue-on-error: true
        run: pnpm run test:visual

      - name: Upload screenshot diffs
        if: steps.visual-tests.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: visual-regression-diffs
          path: |
            site/test-results/
            site/playwright-report/
          retention-days: 30

      - name: Build comment body
        if: always() && github.event_name == 'pull_request'
        id: comment
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const fs = require('fs');
            const path = require('path');
            const snapshotsExist = '${{ steps.snapshots.outputs.exists }}' === 'true';
            const testOutcome = '${{ steps.visual-tests.outcome }}';
            const passed = testOutcome === 'success';
            const failed = testOutcome === 'failure';

            const lines = ['<!-- site-visual-regression-results -->', '## üé® Visual Regression Results', ''];

            if (!snapshotsExist) {
              lines.push(
                '‚ö†Ô∏è **No baseline snapshots found.**',
                '',
                'Run locally and commit the snapshots:',
                '```bash',
                'cd site && pnpm run test:visual:update',
                '```',
              );
            } else if (passed) {
              lines.push('‚úÖ No visual differences detected.');
            } else if (failed) {
              const testResultsDir = 'site/test-results';
              let diffFiles = [];
              if (fs.existsSync(testResultsDir)) {
                const walkDir = (dir) => {
                  const files = fs.readdirSync(dir);
                  for (const file of files) {
                    const filePath = path.join(dir, file);
                    const stat = fs.statSync(filePath);
                    if (stat.isDirectory()) {
                      walkDir(filePath);
                    } else if (file.includes('diff') && file.endsWith('.png')) {
                      diffFiles.push(filePath);
                    }
                  }
                };
                walkDir(testResultsDir);
              }
              lines.push(
                '‚ùå Visual differences were detected in this PR.',
                '',
                `**Diffs found:** ${diffFiles.length}`,
              );
              if (diffFiles.length > 0) {
                lines.push('', '**Files with differences:**');
                for (const f of diffFiles) {
                  lines.push(`- \`${f}\``);
                }
              }
              lines.push(
                '',
                'üì¶ Download the **visual-regression-diffs** artifact to review the changes.',
                '',
                'If these changes are intentional, update the snapshots:',
                '```bash',
                'cd site && pnpm run test:visual:update',
                '```',
              );
            } else {
              lines.push('‚è≠Ô∏è Visual regression tests were skipped.');
            }

            lines.push('', '---', '*Generated by Visual Regression workflow*');
            return lines.join('\n');

      - name: Comment on PR
        if: always() && github.event_name == 'pull_request' && steps.comment.outputs.result
        uses: ./.github/actions/upsert-pr-comment
        with:
          marker: '<!-- site-visual-regression-results -->'
          body: ${{ steps.comment.outputs.result }}

      - name: Fail if visual differences
        if: steps.visual-tests.outcome == 'failure'
        run: exit 1
