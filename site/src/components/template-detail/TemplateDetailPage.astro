---
import ThumbnailDisplay from '../ThumbnailDisplay.astro';
import type { Locale } from '../../i18n/config';
import { t } from '../../i18n/ui';
import { localizeUrl } from '../../i18n/utils';
import { getCloudCtaUrl } from '../../lib/urls';
import { slugify } from '../../lib/slugify';
import creatorsData from '../../../../templates/creators.json';

interface CreatorProfile {
  displayName: string;
  handle: string;
  summary: string;
  social?: string;
  avatarUrl?: string;
  coverUrl?: string;
}

const creators = creatorsData as Record<string, CreatorProfile>;

interface Props {
  template: {
    data: {
      name: string;
      title?: string;
      description: string;
      extendedDescription?: string;
      mediaType: 'image' | 'video' | 'audio' | '3d';
      mediaSubtype?: string;
      thumbnailVariant?: 'compareSlider' | 'hoverDissolve' | 'zoomHover' | 'hoverZoom';
      thumbnails?: string[];
      tags?: string[];
      models?: string[];
      username?: string;
      date?: string;
    };
  };
  locale: Locale;
}

const { template, locale } = Astro.props;
const { data } = template;

const creator = data.username ? creators[data.username] : null;
const authorName = creator ? creator.displayName : 'ComfyUI';
const authorProfileUrl = creator ? localizeUrl(`/templates/${data.username}/`, locale) : null;
const thumbnails = data.thumbnails || [];

const mediaTypeLabels: Record<string, string> = {
  image: t('category.image', locale),
  video: t('category.video', locale),
  audio: t('category.audio', locale),
  '3d': t('category.3d', locale),
};

function formatRelativeDate(dateStr: string): string {
  const now = new Date();
  const date = new Date(dateStr);
  const diffMs = now.getTime() - date.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  if (diffDays === 0) return 'Today';
  if (diffDays === 1) return '1 day ago';
  if (diffDays < 30) return `${diffDays} days ago`;
  const diffMonths = Math.floor(diffDays / 30);
  if (diffMonths === 1) return '1 month ago';
  if (diffMonths < 12) return `${diffMonths} months ago`;
  const diffYears = Math.floor(diffMonths / 12);
  if (diffYears === 1) return '1 year ago';
  return `${diffYears} years ago`;
}
---

<article class="bg-page min-h-screen text-content scroll-smooth">
  <div class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-16 py-6 lg:py-10">
    <div class="flex flex-col gap-6 lg:grid lg:grid-cols-[auto_1fr_24rem] lg:gap-x-16 lg:gap-y-0 lg:mt-6">

      {/* Back button */}
      <a
        href={localizeUrl('/templates/', locale)}
        data-astro-prefetch
        class="self-start inline-flex items-center gap-1 h-10 px-4 py-2 border border-divider rounded-full text-sm text-content hover:border-white/60 transition-colors lg:sticky lg:top-24 lg:col-start-1 lg:row-start-1 lg:row-span-2"
      >
        <svg class="size-4" viewBox="0 0 16 16" fill="none" aria-hidden="true">
          <path d="M12 8H4M4 8l3-3M4 8l3 3" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        {t('nav.backShort', locale)}
      </a>

      {/* Thumbnail */}
      {thumbnails.length > 0 && (
        <div class="rounded-lg overflow-hidden lg:col-start-2 lg:row-start-1">
          <ThumbnailDisplay
            thumbnails={thumbnails}
            title={data.title || data.name}
            variant={data.thumbnailVariant}
            mediaSubtype={data.mediaSubtype}
            class="w-full aspect-square"
            loading="eager"
            fetchpriority="high"
            sizes="(min-width: 1024px) 60vw, 100vw"
          />
        </div>
      )}

      {/* Sidebar */}
      <aside class="flex flex-col lg:col-start-3 lg:row-start-1 lg:row-span-2">
        <div class="flex flex-col gap-6 lg:sticky lg:top-24">
          {/* Creator */}
          <div class="flex flex-col gap-2">
            <span class="px-2 text-xs font-semibold text-content-secondary uppercase tracking-wider">
              {t('labels.createdBy', locale)}
            </span>
            <div class="border border-white/15 rounded-2xl flex items-center justify-between px-4 py-4">
              <div class="flex items-center gap-3">
                <div class="size-8 shrink-0 rounded-full overflow-hidden">
                  {creator?.avatarUrl ? (
                    <img src={creator.avatarUrl} alt={authorName} class="w-full h-full object-cover" loading="lazy" />
                  ) : (
                    <div class="w-full h-full rounded-full bg-white/10 flex items-center justify-center text-xs font-medium text-white">
                      {authorName.charAt(0).toUpperCase()}
                    </div>
                  )}
                </div>
                <div class="flex flex-col">
                  {authorProfileUrl ? (
                    <a href={authorProfileUrl} class="font-semibold text-base text-content hover:opacity-80 transition-opacity" data-astro-prefetch>{authorName}</a>
                  ) : (
                    <span class="font-semibold text-base text-content">{authorName}</span>
                  )}
                  {data.date && <span class="text-base text-content-secondary">{formatRelativeDate(data.date)}</span>}
                </div>
              </div>
              <button class="h-8 px-4 py-2 bg-hub-surface rounded-full text-xs text-content flex items-center gap-1 shrink-0">
                Follow
                <svg class="size-4" viewBox="0 0 16 16" fill="none" aria-hidden="true">
                  <path d="M8 3.333v9.334M3.333 8h9.334" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </button>
            </div>
          </div>

          {/* Description summary */}
          <div class="flex flex-col gap-2">
            <span class="px-2 text-xs font-semibold text-content-secondary uppercase tracking-wider">Description</span>
            <div class="border border-white/15 rounded-2xl flex flex-col gap-4 px-4 py-4">
              <h1 class="text-2xl font-semibold text-content">{data.title || data.name}</h1>
              {data.description && <p class="text-base text-hub-muted line-clamp-4">{data.description}</p>}
              <a href="#description" class="flex items-center justify-between px-4 h-8 rounded-full text-xs text-content hover:bg-white/5 transition-colors">
                See more
                <svg class="size-4" viewBox="0 0 16 16" fill="none" aria-hidden="true">
                  <path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </a>
            </div>
          </div>

          {/* Categories */}
          {data.tags && data.tags.length > 0 && (
            <div class="flex flex-col gap-2">
              <span class="px-2 text-xs font-semibold text-content-secondary uppercase tracking-wider">{t('labels.categories', locale)}</span>
              <div class="border border-white/15 rounded-2xl flex flex-col gap-4 px-4 py-4">
                <div class="flex flex-wrap gap-2">
                  <a href={localizeUrl(`/templates/category/${data.mediaType}/`, locale)} class="h-6 px-4 py-1 bg-hub-surface rounded-full text-xs text-content inline-flex items-center justify-center hover:opacity-80 transition-opacity" data-astro-prefetch>{mediaTypeLabels[data.mediaType]}</a>
                  {data.tags.map((tag: string) => (
                    <a href={localizeUrl(`/templates/tag/${slugify(tag)}/`, locale)} class="h-6 px-4 py-1 bg-hub-surface rounded-full text-xs text-content inline-flex items-center justify-center hover:opacity-80 transition-opacity" data-astro-prefetch>{tag}</a>
                  ))}
                </div>
                <a href={localizeUrl(`/templates/category/${data.mediaType}/`, locale)} class="flex items-center justify-between px-4 h-8 rounded-full text-xs text-content hover:bg-white/5 transition-colors" data-astro-prefetch>
                  See all
                  <svg class="size-4" viewBox="0 0 16 16" fill="none" aria-hidden="true"><path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round" /></svg>
                </a>
              </div>
            </div>
          )}

          {/* Models */}
          {data.models && data.models.length > 0 && (
            <div class="flex flex-col gap-2">
              <span class="px-2 text-xs font-semibold text-content-secondary uppercase tracking-wider">{t('labels.models', locale)}</span>
              <div class="border border-white/15 rounded-2xl flex flex-col gap-4 px-4 py-4">
                <div class="flex flex-wrap gap-2">
                  {data.models.map((model: string) => (
                    <span class="h-6 px-4 py-1 bg-hub-surface rounded-full text-xs text-content inline-flex items-center justify-center">{model}</span>
                  ))}
                </div>
                <span class="flex items-center justify-between px-4 h-8 rounded-full text-xs text-content">
                  See all
                  <svg class="size-4" viewBox="0 0 16 16" fill="none" aria-hidden="true"><path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round" /></svg>
                </span>
              </div>
            </div>
          )}

          {/* Action buttons */}
          <div class="flex flex-col gap-2 lg:pt-10">
            <a href={`/workflows/${data.name}.json`} download class="download-json-btn flex items-center justify-center h-10 border border-divider rounded-full text-sm text-content hover:border-white/60 transition-colors" data-template={data.name}>
              {t('cta.downloadJson', locale)}
            </a>
            <a href={getCloudCtaUrl(data.name, 'hero')} target="_blank" rel="noopener noreferrer" class="flex items-center justify-center h-10 bg-brand rounded-full text-sm font-bold text-page hover:opacity-90 transition-opacity">
              {t('cta.tryCloud', locale)}
            </a>
          </div>
        </div>
      </aside>

      {/* Full description */}
      <div class="flex flex-col gap-6 lg:col-start-2 lg:row-start-2 lg:mt-12 scroll-mt-8" id="description">
        <hr class="border-0 border-t border-divider lg:hidden" />
        {data.description && (
          <p class="text-base leading-relaxed text-content-secondary">{data.description}</p>
        )}
        {data.extendedDescription && (
          <div class="flex flex-col gap-4">
            {data.extendedDescription.split('\n\n').filter(Boolean).map((paragraph: string) => (
              <p class="text-base leading-relaxed text-content-secondary">{paragraph.trim()}</p>
            ))}
          </div>
        )}
      </div>
    </div>
  </div>
</article>

<script is:inline define:vars={{ templateName: data.name }}>
  document.querySelectorAll('a[href*="cloud.comfy.org"]').forEach((link) => {
    link.addEventListener('click', () => {
      if (window.va) {
        window.va('event', { name: 'cta_click', template: templateName, location: 'hero' });
      }
    });
  });
  document.querySelectorAll('.download-json-btn').forEach((link) => {
    link.addEventListener('click', () => {
      if (window.va) {
        window.va('event', { name: 'download_json', template: templateName });
      }
    });
  });
</script>
