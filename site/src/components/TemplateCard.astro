---
import ThumbnailDisplay from './ThumbnailDisplay.astro';
import { DEFAULT_LOCALE, type Locale } from '../i18n/config';
import { localizeUrl } from '../i18n/utils';

interface Props {
  name: string;
  title: string;
  description: string;
  mediaType: 'image' | 'video' | 'audio' | '3d';
  mediaSubtype?: string;
  thumbnailVariant?: 'compareSlider' | 'hoverDissolve' | 'zoomHover' | 'hoverZoom';
  tags?: string[];
  models?: string[];
  usage?: number;
  date?: string;
  thumbnails?: string[];
  locale?: Locale;
}

const {
  name,
  title,
  description,
  mediaType,
  mediaSubtype,
  thumbnailVariant,
  tags = [],
  usage,
  date,
  thumbnails = [],
  locale = DEFAULT_LOCALE,
} = Astro.props;

// Build the localized URL for this template
const templateUrl = localizeUrl(`/templates/${name}/`, locale);

const mediaTypeConfig: Record<string, { label: string; color: string }> = {
  image: { label: 'Image', color: 'bg-blue-500' },
  video: { label: 'Video', color: 'bg-purple-500' },
  audio: { label: 'Audio', color: 'bg-green-500' },
  '3d': { label: '3D', color: 'bg-orange-500' },
};

const config = mediaTypeConfig[mediaType] || { label: mediaType, color: 'bg-gray-500' };

const getPopularity = (count: number, dateStr?: string): { label: string; icon: boolean } => {
  const ageDays = dateStr
    ? Math.max(1, (Date.now() - new Date(dateStr).getTime()) / 86_400_000)
    : 90;
  const velocity = count / ageDays;

  if (count >= 5000 || velocity >= 50) return { label: 'Very Popular', icon: true };
  if (count >= 500 || velocity >= 10) return { label: 'Popular', icon: true };
  if (velocity >= 3 || (ageDays <= 30 && count >= 50)) return { label: 'Trending', icon: true };
  return { label: '', icon: false };
};

const popularity = usage !== undefined ? getPopularity(usage, date) : null;
---

<a
  href={templateUrl}
  class="group block bg-white/5 rounded-xl border border-white/10 overflow-hidden hover:border-white/20 transition-all duration-200"
  data-astro-prefetch
>
  <!-- Thumbnail -->
  <div class="aspect-video bg-white/5 relative">
    {
      thumbnails.length > 0 ? (
        <ThumbnailDisplay
          thumbnails={thumbnails}
          title={title}
          variant={thumbnailVariant}
          mediaSubtype={mediaSubtype}
          class="w-full h-full"
        />
      ) : (
        <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-white/5 to-white/10">
          <svg
            class="w-10 h-10 text-white/20"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5"
              d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909M3.75 21h16.5A2.25 2.25 0 0022.5 18.75V5.25A2.25 2.25 0 0020.25 3H3.75A2.25 2.25 0 001.5 5.25v13.5A2.25 2.25 0 003.75 21z"
            />
          </svg>
        </div>
      )
    }

    <!-- Media type badge -->
    <span
      class={`absolute top-3 left-3 px-2 py-1 text-xs font-medium text-white rounded ${config.color} z-10`}
    >
      {config.label}
    </span>
  </div>

  <!-- Content -->
  <div class="p-4">
    <h3
      class="font-semibold text-white mb-1 line-clamp-1 group-hover:text-[#F0FF41] transition-colors"
    >
      {title}
    </h3>

    <p class="text-sm text-white/60 line-clamp-2 mb-3">
      {description}
    </p>

    <!-- Meta -->
    <div class="flex items-center justify-between text-xs text-white/40">
      <div class="flex items-center gap-2">
        {
          popularity?.label && (
            <span class="flex items-center gap-1">
              <svg
                class="w-3.5 h-3.5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 10V3L4 14h7v7l9-11h-7z"
                />
              </svg>
              {popularity.label}
            </span>
          )
        }
      </div>

      {
        tags.length > 0 && (
          <span class="px-2 py-0.5 bg-white/10 text-white/60 rounded">{tags[0]}</span>
        )
      }
    </div>
  </div>
</a>
