---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import TemplateCard from '../../components/TemplateCard.astro';
import HreflangTags from '../../components/HreflangTags.astro';
import { getLocaleFromPath, localizeUrl } from '../../i18n/utils';
import { t } from '../../i18n/ui';

type MediaType = 'image' | 'video' | 'audio' | '3d';

const categoryTranslationKeys: Record<MediaType, string> = {
  image: 'category.image',
  video: 'category.video',
  audio: 'category.audio',
  '3d': 'category.3d',
};

export async function getStaticPaths() {
  const mediaTypes: MediaType[] = ['image', 'video', 'audio', '3d'];
  return mediaTypes.map((type) => ({
    params: { type },
    props: { type },
  }));
}

const { type } = Astro.props as { type: MediaType };
const locale = getLocaleFromPath(Astro.url.pathname);

const categoryName = t(categoryTranslationKeys[type], locale);
const title = `${categoryName} Workflows - ${t('meta.title', locale)}`;
const description = t('meta.description', locale);

const allTemplates = await getCollection('templates');
const templates = allTemplates
  .filter((tmpl) => !tmpl.id.includes('/'))
  .filter((tmpl) => tmpl.data.mediaType === type)
  .sort((a, b) => (b.data.usage || 0) - (a.data.usage || 0));

const siteUrl = Astro.site?.origin || 'https://templates.comfy.org';
const basePath = `/category/${type}/`;
const canonicalUrl = `${siteUrl}${localizeUrl(basePath, locale)}`;

const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: categoryName,
  description: description,
  url: canonicalUrl,
};

const breadcrumbStructuredData = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Home', item: siteUrl },
    {
      '@type': 'ListItem',
      position: 2,
      name: t('nav.templates', locale),
      item: `${siteUrl}${localizeUrl('/templates/', locale)}`,
    },
    { '@type': 'ListItem', position: 3, name: categoryName },
  ],
};

const categoryFaqs: Record<MediaType, Array<{ question: string; answer: string }>> = {
  image: [
    {
      question: 'What is AI image generation with ComfyUI?',
      answer:
        'AI image generation with ComfyUI uses node-based workflows to create images from text prompts or modify existing images. ComfyUI supports models like Stable Diffusion, SDXL, and Flux for high-quality image synthesis.',
    },
    {
      question: 'What image formats does ComfyUI support?',
      answer:
        'ComfyUI supports PNG, JPEG, and WebP output formats. PNG is recommended for lossless quality, while JPEG and WebP offer smaller file sizes. Most workflows default to PNG at configurable resolutions.',
    },
    {
      question: 'What are the hardware requirements for image generation?',
      answer:
        'Image generation typically requires a GPU with at least 6GB VRAM for SD 1.5, 8GB+ for SDXL, and 12GB+ for Flux models. CPU-only generation is possible but significantly slower.',
    },
    {
      question: 'How do I improve image generation quality?',
      answer:
        'Improve quality by using higher step counts (20-50), appropriate CFG scale (5-12), quality samplers like DPM++ 2M Karras, and detailed prompts. Upscaling workflows can enhance resolution after initial generation.',
    },
  ],
  video: [
    {
      question: 'What is AI video generation with ComfyUI?',
      answer:
        'AI video generation in ComfyUI creates animated content from text, images, or existing videos using models like AnimateDiff, SVD (Stable Video Diffusion), and Mochi. Workflows can generate short clips, animate still images, or apply effects.',
    },
    {
      question: 'What video durations and frame rates are supported?',
      answer:
        'Most video workflows generate 2-6 second clips at 8-24 FPS due to VRAM constraints. AnimateDiff typically produces 16-32 frames, while SVD generates 14-25 frames. Longer videos require frame interpolation or segment stitching.',
    },
    {
      question: 'What are the hardware requirements for video generation?',
      answer:
        'Video generation is VRAM-intensive, requiring 12GB+ for AnimateDiff and 16GB+ for SVD/Mochi. Batch processing and temporal attention increase memory usage compared to image generation.',
    },
    {
      question: 'What video formats does ComfyUI output?',
      answer:
        'ComfyUI outputs video as image sequences (PNG frames) or encoded MP4/GIF using video combine nodes. H.264 MP4 is common for sharing, while PNG sequences preserve quality for editing.',
    },
  ],
  audio: [
    {
      question: 'What is AI audio generation with ComfyUI?',
      answer:
        'AI audio generation in ComfyUI creates music, sound effects, and speech using models like AudioLDM, MusicGen, and Bark. Workflows can generate audio from text descriptions or transform existing audio.',
    },
    {
      question: 'What audio formats and quality does ComfyUI support?',
      answer:
        'ComfyUI outputs audio as WAV files at various sample rates (16kHz-48kHz). Most models generate at 16kHz or 32kHz. Higher sample rates provide better quality for music generation.',
    },
    {
      question: 'Can I generate music with ComfyUI?',
      answer:
        'Yes, ComfyUI supports music generation through MusicGen and similar models. You can create instrumental tracks, specify genres and instruments via text prompts, and control duration up to 30 seconds per generation.',
    },
    {
      question: 'What are the hardware requirements for audio generation?',
      answer:
        'Audio generation requires less VRAM than image/video, typically 4-8GB. MusicGen models range from 300M to 3.3B parameters. CPU inference is viable for smaller models.',
    },
  ],
  '3d': [
    {
      question: 'What is AI 3D generation with ComfyUI?',
      answer:
        'AI 3D generation in ComfyUI creates 3D models, meshes, and point clouds from images or text using models like TripoSR, InstantMesh, and Zero123. Workflows can generate textured meshes ready for use in 3D applications.',
    },
    {
      question: 'What 3D file formats does ComfyUI support?',
      answer:
        'ComfyUI exports 3D models as OBJ, GLB/GLTF, and PLY formats. GLB is recommended for web and game engines, OBJ for traditional 3D software, and PLY for point cloud data.',
    },
    {
      question: 'Can I generate 3D models from a single image?',
      answer:
        'Yes, image-to-3D workflows using TripoSR or similar models can generate 3D meshes from a single reference image. Multi-view approaches with Zero123 improve quality by generating multiple viewpoints first.',
    },
    {
      question: 'What are the hardware requirements for 3D generation?',
      answer:
        '3D generation typically requires 8-12GB VRAM. TripoSR runs on 8GB GPUs, while more complex multi-view pipelines need 12GB+. Mesh refinement and texturing add additional memory requirements.',
    },
  ],
};

const faqItems = categoryFaqs[type] || [];

const faqStructuredData = faqItems.length
  ? {
      '@context': 'https://schema.org',
      '@type': 'FAQPage',
      mainEntity: faqItems.map((item) => ({
        '@type': 'Question',
        name: item.question,
        acceptedAnswer: {
          '@type': 'Answer',
          text: item.answer,
        },
      })),
    }
  : null;
---

<BaseLayout
  title={title}
  description={description}
  canonicalUrl={canonicalUrl}
  ogImage="/og-default.svg"
  structuredData={structuredData}
  theme="dark"
>
  <HreflangTags slot="head" basePath={basePath} />
  <div class="max-w-6xl mx-auto px-4 py-12">
    <!-- Breadcrumb -->
    <nav class="mb-8">
      <a
        href={localizeUrl('/templates/', locale)}
        data-astro-prefetch
        class="inline-flex items-center gap-2 text-white/40 hover:text-white font-medium transition-colors"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"
          ></path>
        </svg>
        {t('nav.back', locale)}
      </a>
    </nav>

    <!-- Header -->
    <div class="text-center mb-12">
      <h1 class="text-4xl sm:text-5xl font-bold text-white mb-4">
        {categoryName}
      </h1>
      <p class="text-xl text-white/70 max-w-2xl mx-auto">
        {description}
      </p>
    </div>

    <!-- Stats bar -->
    <div class="flex justify-center gap-8 mb-12 text-sm text-white/50">
      <span class="flex items-center gap-2">
        <span class="w-2 h-2 bg-green-500 rounded-full"></span>
        {templates.length}
        {t('template.count', locale)}
      </span>
    </div>

    <!-- Grid -->
    {
      templates.length > 0 ? (
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {templates.map((template) => (
            <TemplateCard
              name={template.data.name}
              title={template.data.title || template.data.name}
              description={template.data.description}
              mediaType={template.data.mediaType}
              mediaSubtype={template.data.mediaSubtype}
              thumbnailVariant={template.data.thumbnailVariant}
              tags={template.data.tags}
              models={template.data.models}
              usage={template.data.usage}
            date={template.data.date}
              thumbnails={template.data.thumbnails}
              locale={locale}
            />
          ))}
        </div>
      ) : (
        <div class="text-center py-16">
          <p class="text-white/50 text-lg">No templates found in this category yet.</p>
          <a
            href={localizeUrl('/templates/', locale)}
            data-astro-prefetch
            class="mt-4 inline-block text-[#F0FF41] hover:text-[#F0FF41]/80 font-medium"
          >
            {t('nav.templates', locale)} â†’
          </a>
        </div>
      )
    }
  </div>

  <script
    is:inline
    type="application/ld+json"
    set:html={JSON.stringify(breadcrumbStructuredData)}
  />
  {
    faqStructuredData && (
      <script is:inline type="application/ld+json" set:html={JSON.stringify(faqStructuredData)} />
    )
  }
</BaseLayout>
