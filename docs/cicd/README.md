# CI/CD System Overview

## Package Architecture
```
comfyui-workflow-templates/           # Meta package (depends on all others)
├── comfyui-workflow-templates-core   # Manifest + core logic
├── comfyui-workflow-templates-media-api     # API templates
├── comfyui-workflow-templates-media-video   # Video templates  
├── comfyui-workflow-templates-media-image   # Image templates
└── comfyui-workflow-templates-media-other   # Other templates
```

## Workflow Pipeline
```
Template Added → Version Check → Package Bump → Publish → PyPI + GitHub Release
```

### 1. Template Addition (PR)
- Add template files to `templates/`
- **MUST** add template IDs to appropriate bundle in `bundles.json`
- CI auto-bumps affected package versions + updates meta dependencies

### 2. Version Detection (`ci_version_manager.py`)
- Analyzes git history since last package tag
- Bumps packages with template changes
- Updates meta package dependencies (exact pinning `==x.y.z`)

### 3. Publishing (`publish.yml`)
- Triggers on `pyproject.toml` changes (main branch)
- Builds packages in dependency order (subpackages → meta)
- Recovery mode: publishes any packages newer than PyPI

## Critical Files
- `bundles.json` - Template→package mapping (REQUIRED for new templates)
- `pyproject.toml` - Meta package with exact dependencies
- `packages/*/pyproject.toml` - Individual package versions
- Template manifests auto-generated by `sync_bundles.py`

## Key Scripts
- `scripts/ci_version_manager.py` - Version detection/bumping logic
- `scripts/sync_bundles.py` - Template validation + manifest generation
- `scripts/validate_manifests.py` - SHA256 + file consistency checks

## Validation Rules
- All templates in `templates/*.json` MUST be assigned in `bundles.json`
- Template assets MUST match manifest SHA256 hashes
- Package versions MUST use semantic versioning
- Meta dependencies MUST use exact pinning (`==x.y.z`)