---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import ThumbnailDisplay from '../../components/ThumbnailDisplay.astro';

export async function getStaticPaths() {
  const templates = await getCollection('templates');
  return templates.map((template) => ({
    params: { slug: template.data.name },
    props: { template },
  }));
}

const { template } = Astro.props;
const { data } = template;

const title = `${data.title || data.name} - ComfyUI Workflow`;
const canonicalUrl = `https://templates.comfy.org/templates/${data.name}/`;

const thumbnails = data.thumbnails || [];
const primaryThumbnail = thumbnails[0] || null;
const workflowPreviewPath = `/previews/${data.name}.png`;

const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'TechArticle',
  headline: data.title || data.name,
  description: data.description,
  image: primaryThumbnail ? `https://templates.comfy.org/thumbnails/${primaryThumbnail}` : undefined,
  datePublished: data.date,
};

const faqStructuredData = data.faqItems?.length ? {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: data.faqItems.map((item: { question: string; answer: string }) => ({
    '@type': 'Question',
    name: item.question,
    acceptedAnswer: { '@type': 'Answer', text: item.answer },
  })),
} : null;

const mediaTypeLabels: Record<string, string> = {
  image: 'Image Generation',
  video: 'Video Generation', 
  audio: 'Audio Generation',
  '3d': '3D Generation',
};

function formatDate(dateStr: string): string {
  return new Date(dateStr).toLocaleDateString('en-US', { 
    year: 'numeric', month: 'long', day: 'numeric' 
  });
}

function formatBytes(bytes: number): string {
  const gb = bytes / (1024 * 1024 * 1024);
  return gb >= 1 ? `${gb.toFixed(1)} GB` : `${(bytes / (1024 * 1024)).toFixed(0)} MB`;
}
---

<BaseLayout
  title={title}
  description={data.metaDescription || data.description}
  canonicalUrl={canonicalUrl}
  ogType="article"
  structuredData={structuredData}
>
  <article class="max-w-4xl mx-auto px-4 py-8">
    
    <!-- Breadcrumb -->
    <nav class="mb-8">
      <a href="/templates/" class="inline-flex items-center gap-2 text-indigo-600 hover:text-indigo-800 font-medium transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        Back to Templates
      </a>
    </nav>

    <!-- Header -->
    <header class="mb-8">
      <div class="flex flex-wrap items-center gap-3 text-sm text-gray-500 mb-3">
        <span class="px-2.5 py-1 bg-indigo-100 text-indigo-700 font-medium rounded-full">
          {mediaTypeLabels[data.mediaType]}
        </span>
        {data.date && <span>{formatDate(data.date)}</span>}
        {data.usage !== undefined && (
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
            {data.usage.toLocaleString()} runs
          </span>
        )}
        {data.openSource === false && (
          <span class="px-2.5 py-1 bg-amber-100 text-amber-700 font-medium rounded-full">
            Cloud API
          </span>
        )}
      </div>
      
      <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-4">
        {data.title || data.name}
      </h1>
      
      <p class="text-xl text-gray-600 leading-relaxed">
        {data.description}
      </p>
    </header>

    <!-- Hero Image -->
    {thumbnails.length > 0 && (
      <figure class="mb-8 rounded-xl overflow-hidden bg-gray-100 shadow-lg">
        <ThumbnailDisplay 
          thumbnails={thumbnails}
          title={data.title || data.name}
          variant={data.thumbnailVariant}
          mediaSubtype={data.mediaSubtype}
          class="w-full aspect-video"
          loading="eager"
        />
        <figcaption class="px-4 py-3 bg-gray-50 text-sm text-gray-600 text-center">
          {data.thumbnailVariant === 'compareSlider' 
            ? 'Drag the slider to compare input and output'
            : data.thumbnailVariant === 'hoverDissolve'
            ? 'Hover to see the transformation'
            : 'Example output generated by this workflow'}
        </figcaption>
      </figure>
    )}

    <!-- CTA Button -->
    <div class="mb-12 p-6 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border border-indigo-100">
      <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
        <div>
          <h2 class="text-lg font-semibold text-gray-900 mb-1">Try this workflow</h2>
          <p class="text-gray-600">Run instantly on Comfy Cloud â€” no setup required</p>
        </div>
        <a 
          href={`https://www.comfy.org/get-started?template=${data.name}`}
          class="inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors shadow-md hover:shadow-lg"
        >
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <polygon points="5 3 19 12 5 21 5 3"/>
          </svg>
          Run on Comfy Cloud
        </a>
      </div>
    </div>

    <!-- Content -->
    <div class="prose prose-lg prose-gray max-w-none">
      
      <!-- About -->
      <section class="mb-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">About This Workflow</h2>
        <p class="text-gray-700 leading-relaxed">
          {data.extendedDescription || data.description}
        </p>
      </section>

      <!-- More Examples -->
      {thumbnails.length > 1 && (
        <section class="mb-12">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">More Examples</h2>
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
            {thumbnails.slice(1).map((thumb: string) => (
              <img 
                src={`/thumbnails/${thumb}`} 
                alt="Additional example"
                class="rounded-lg shadow-md"
                loading="lazy"
              />
            ))}
          </div>
        </section>
      )}

      <!-- How to Use -->
      {data.howToUse && data.howToUse.length > 0 && (
        <section class="mb-12">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">How to Use</h2>
          <div class="space-y-4">
            {data.howToUse.map((step: string, i: number) => (
              <div class="flex gap-4 items-start p-4 bg-gray-50 rounded-lg">
                <span class="flex-shrink-0 w-8 h-8 bg-indigo-600 text-white font-bold rounded-full flex items-center justify-center text-sm">
                  {i + 1}
                </span>
                <p class="text-gray-700 pt-1">{step}</p>
              </div>
            ))}
          </div>
        </section>
      )}

      <!-- Workflow Preview -->
      <section class="mb-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Workflow Structure</h2>
        <figure class="rounded-xl overflow-hidden border border-gray-200 bg-gray-900">
          <img 
            src={workflowPreviewPath} 
            alt={`Workflow graph for ${data.title || data.name}`}
            class="w-full"
            loading="lazy"
          />
          <figcaption class="px-4 py-3 bg-gray-800 text-sm text-gray-400 text-center">
            ComfyUI node graph visualization
          </figcaption>
        </figure>
        <p class="mt-3 text-sm text-gray-500 italic">
          Note: This is a simplified visualization. The actual workflow may contain additional nodes and connections.
        </p>
      </section>

      <!-- Use Cases -->
      {data.suggestedUseCases && data.suggestedUseCases.length > 0 && (
        <section class="mb-12">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Use Cases</h2>
          <ul class="space-y-2">
            {data.suggestedUseCases.map((useCase: string) => (
              <li class="flex items-start gap-3 text-gray-700">
                <svg class="w-5 h-5 text-green-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                {useCase}
              </li>
            ))}
          </ul>
        </section>
      )}

      <!-- Technical Details -->
      <section class="mb-12 p-6 bg-gray-50 rounded-xl">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Technical Details</h2>
        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          {data.models && data.models.length > 0 && (
            <div>
              <dt class="text-sm font-medium text-gray-500 mb-1">Models</dt>
              <dd class="flex flex-wrap gap-2">
                {data.models.map((model: string) => (
                  <span class="px-2 py-1 bg-white border border-gray-200 text-gray-700 text-sm rounded">
                    {model}
                  </span>
                ))}
              </dd>
            </div>
          )}
          {data.tags && data.tags.length > 0 && (
            <div>
              <dt class="text-sm font-medium text-gray-500 mb-1">Tags</dt>
              <dd class="flex flex-wrap gap-2">
                {data.tags.map((tag: string) => (
                  <span class="px-2 py-1 bg-white border border-gray-200 text-gray-700 text-sm rounded">
                    {tag}
                  </span>
                ))}
              </dd>
            </div>
          )}
          {data.size && (
            <div>
              <dt class="text-sm font-medium text-gray-500 mb-1">Download Size</dt>
              <dd class="text-gray-700">{formatBytes(data.size)}</dd>
            </div>
          )}
          {data.vram && (
            <div>
              <dt class="text-sm font-medium text-gray-500 mb-1">VRAM Required</dt>
              <dd class="text-gray-700">{formatBytes(data.vram)}</dd>
            </div>
          )}
        </dl>
      </section>

      <!-- FAQ -->
      {data.faqItems && data.faqItems.length > 0 && (
        <section class="mb-12">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Frequently Asked Questions</h2>
          <div class="space-y-3">
            {data.faqItems.map((item: { question: string; answer: string }) => (
              <details class="group border border-gray-200 rounded-lg overflow-hidden">
                <summary class="flex items-center justify-between p-4 cursor-pointer bg-white hover:bg-gray-50 transition-colors">
                  <span class="font-medium text-gray-900">{item.question}</span>
                  <svg class="w-5 h-5 text-gray-500 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </summary>
                <div class="px-4 pb-4 text-gray-700">
                  {item.answer}
                </div>
              </details>
            ))}
          </div>
        </section>
      )}
    </div>

    <!-- Footer CTA -->
    <footer class="mt-12 p-8 bg-gradient-to-r from-gray-900 to-indigo-900 rounded-2xl text-center">
      <h2 class="text-2xl font-bold text-white mb-2">Ready to create?</h2>
      <p class="text-gray-300 mb-6">Start generating with this workflow in seconds</p>
      <a 
        href={`https://www.comfy.org/get-started?template=${data.name}`}
        class="inline-flex items-center gap-2 px-8 py-4 bg-white text-gray-900 font-bold rounded-lg hover:bg-gray-100 transition-colors shadow-lg"
      >
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
          <polygon points="5 3 19 12 5 21 5 3"/>
        </svg>
        Run on Comfy Cloud
      </a>
    </footer>

  </article>
</BaseLayout>

{faqStructuredData && (
  <script type="application/ld+json" set:html={JSON.stringify(faqStructuredData)} />
)}
