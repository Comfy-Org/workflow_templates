---
import BaseLayout from '../../layouts/BaseLayout.astro';
import TemplateDetailPage from '../../components/template-detail/TemplateDetailPage.astro';
import { DEFAULT_LOCALE } from '../../i18n/config';
import { getTemplatesForLocale } from '../../lib/templates';

export async function getStaticPaths() {
  // Only generate English (default locale) pages here
  // Localized pages are generated by [locale]/templates/[slug].astro
  const templates = await getTemplatesForLocale(DEFAULT_LOCALE);
  return templates.map((template) => ({
    params: { slug: template.data.name },
    props: { template },
  }));
}

const { template } = Astro.props;
const locale = DEFAULT_LOCALE;
const { data } = template;

const siteUrl = Astro.site?.origin || 'https://templates.comfy.org';
const title = `${data.title || data.name} - ComfyUI Workflow`;
const hreflangBasePath = `/templates/${data.name}/`;
const canonicalUrl = `${siteUrl}${hreflangBasePath}`;

const thumbnails = data.thumbnails || [];
const primaryThumbnail = thumbnails[0] || null;
const ogImage = `/og/${data.name}.png`;

const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'TechArticle',
  headline: data.title || data.name,
  description: data.description,
  image: primaryThumbnail
    ? `https://templates.comfy.org/thumbnails/${primaryThumbnail}`
    : undefined,
  datePublished: data.date,
  inLanguage: 'en',
};

const faqStructuredData = data.faqItems?.length
  ? {
      '@context': 'https://schema.org',
      '@type': 'FAQPage',
      mainEntity: data.faqItems.map((item: { question: string; answer: string }) => ({
        '@type': 'Question',
        name: item.question,
        acceptedAnswer: { '@type': 'Answer', text: item.answer },
      })),
    }
  : null;

const breadcrumbStructuredData = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Home', item: siteUrl },
    { '@type': 'ListItem', position: 2, name: 'Templates', item: `${siteUrl}/templates/` },
    { '@type': 'ListItem', position: 3, name: data.title || data.name, item: canonicalUrl },
  ],
};

const softwareAppStructuredData = {
  '@context': 'https://schema.org',
  '@type': 'SoftwareApplication',
  name: data.title || data.name,
  applicationCategory: 'MultimediaApplication',
  operatingSystem: 'Windows, macOS, Linux',
  description: data.metaDescription || data.description,
  offers: {
    '@type': 'Offer',
    price: '0',
    priceCurrency: 'USD',
  },
};
---

<BaseLayout
  title={title}
  description={data.metaDescription || data.description}
  canonicalUrl={canonicalUrl}
  ogImage={ogImage}
  ogType="article"
  structuredData={structuredData}
  hreflangBasePath={hreflangBasePath}
  theme="dark"
>
  <TemplateDetailPage template={{ data }} locale={locale} />

  {faqStructuredData && (
    <script is:inline type="application/ld+json" set:html={JSON.stringify(faqStructuredData)} />
  )}
  <script is:inline type="application/ld+json" set:html={JSON.stringify(softwareAppStructuredData)} />
  <script is:inline type="application/ld+json" set:html={JSON.stringify(breadcrumbStructuredData)} />
</BaseLayout>
