name: Lint Site

on:
  push:
    branches: [main]
    paths:
      - 'site/**'
      - '.github/workflows/lint-site.yml'
  pull_request:
    branches: [main]
    paths:
      - 'site/**'
      - '.github/workflows/lint-site.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  lint-and-format:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: site
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/site-setup

      - name: Run ESLint
        id: lint
        continue-on-error: true
        run: pnpm run lint 2>&1 | tee lint-output.txt

      - name: Check Prettier formatting
        id: format
        continue-on-error: true
        run: pnpm run format:check 2>&1 | tee format-output.txt

      - name: Build comment body
        if: always() && github.event_name == 'pull_request'
        id: comment
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const fs = require('fs');
            const lintOutcome = '${{ steps.lint.outcome }}';
            const formatOutcome = '${{ steps.format.outcome }}';
            const allPassed = lintOutcome === 'success' && formatOutcome === 'success';

            const icon = (outcome) => outcome === 'success' ? '‚úÖ' : '‚ùå';

            const lines = [
              '<!-- site-lint-results -->',
              '## üßπ Lint & Format Results',
              '',
              '| Check | Status |',
              '|-------|--------|',
              `| ESLint | ${icon(lintOutcome)} ${lintOutcome} |`,
              `| Prettier | ${icon(formatOutcome)} ${formatOutcome} |`,
            ];

            if (!allPassed) {
              lines.push('', '<details>', '<summary>Error details</summary>', '');
              if (lintOutcome !== 'success') {
                let lintOutput = '';
                try {
                  lintOutput = fs.readFileSync('site/lint-output.txt', 'utf8').trim();
                } catch (e) { lintOutput = 'Could not read lint output'; }
                lines.push('**ESLint:**', '```', lintOutput.slice(-2000), '```', '');
              }
              if (formatOutcome !== 'success') {
                let formatOutput = '';
                try {
                  formatOutput = fs.readFileSync('site/format-output.txt', 'utf8').trim();
                } catch (e) { formatOutput = 'Could not read format output'; }
                lines.push('**Prettier:**', '```', formatOutput.slice(-2000), '```', '');
              }
              lines.push(
                '</details>',
                '',
                'To fix locally:',
                '```bash',
                'cd site',
                'pnpm run lint:fix && pnpm run format',
                '```',
              );
            }

            lines.push('', '---', '*Generated by Lint Site workflow*');
            return lines.join('\n');

      - name: Comment on PR
        if: always() && github.event_name == 'pull_request' && steps.comment.outputs.result
        uses: ./.github/actions/upsert-pr-comment
        with:
          marker: '<!-- site-lint-results -->'
          body: ${{ steps.comment.outputs.result }}

      - name: Fail if checks failed
        if: steps.lint.outcome == 'failure' || steps.format.outcome == 'failure'
        run: exit 1
