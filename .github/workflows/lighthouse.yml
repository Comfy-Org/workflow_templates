name: Lighthouse CI

on:
  pull_request:
    paths:
      - 'site/**'
      - '.github/workflows/lighthouse.yml'
  push:
    branches: [main]
    paths:
      - 'site/**'
      - '.github/workflows/lighthouse.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: site
    steps:
      - name: Setup
        uses: ./.github/actions/site-setup

      - name: Build site
        run: pnpm run build
        env:
          SKIP_AI_GENERATION: 'true'

      - name: Run Lighthouse CI
        id: lhci
        uses: treosh/lighthouse-ci-action@v12
        with:
          uploadArtifacts: true
          temporaryPublicStorage: true
          configPath: site/lighthouserc.json
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Build comment body
        if: always() && github.event_name == 'pull_request'
        id: comment
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const fs = require('fs');
            const path = require('path');

            let results = [];
            const lhciDir = '.lighthouseci';
            try {
              const files = fs.readdirSync(lhciDir).filter(f => f.startsWith('lhr-') && f.endsWith('.json'));
              for (const file of files) {
                const raw = fs.readFileSync(path.join(lhciDir, file), 'utf8');
                const lhr = JSON.parse(raw);
                results.push({
                  url: lhr.finalUrl || lhr.requestedUrl || 'unknown',
                  performance: Math.round((lhr.categories?.performance?.score || 0) * 100),
                  accessibility: Math.round((lhr.categories?.accessibility?.score || 0) * 100),
                  bestPractices: Math.round((lhr.categories?.['best-practices']?.score || 0) * 100),
                  seo: Math.round((lhr.categories?.seo?.score || 0) * 100),
                });
              }
            } catch (e) {
              // No results available
            }

            if (results.length === 0) {
              return '';
            }

            const scoreEmoji = (score) => {
              if (score >= 90) return 'ðŸŸ¢';
              if (score >= 50) return 'ðŸŸ ';
              return 'ðŸ”´';
            };

            const lines = [
              '<!-- site-lighthouse-results -->',
              '## âš¡ Lighthouse Results',
              '',
              '| URL | Performance | Accessibility | Best Practices | SEO |',
              '|-----|-------------|---------------|----------------|-----|',
            ];

            for (const r of results) {
              const urlPath = new URL(r.url).pathname || '/';
              lines.push(
                `| \`${urlPath}\` | ${scoreEmoji(r.performance)} ${r.performance} | ${scoreEmoji(r.accessibility)} ${r.accessibility} | ${scoreEmoji(r.bestPractices)} ${r.bestPractices} | ${scoreEmoji(r.seo)} ${r.seo} |`
              );
            }

            lines.push(
              '',
              '_Scores are out of 100. ðŸŸ¢ 90+ | ðŸŸ  50-89 | ðŸ”´ 0-49_',
              '',
              '---',
              '*Generated by Lighthouse CI workflow*',
            );

            return lines.join('\n');

      - name: Comment on PR
        if: always() && github.event_name == 'pull_request' && steps.comment.outputs.result
        uses: ./.github/actions/upsert-pr-comment
        with:
          marker: '<!-- site-lighthouse-results -->'
          body: ${{ steps.comment.outputs.result }}
